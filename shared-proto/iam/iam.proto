syntax = "proto3";

package iam;

option go_package = "github.com/brianwong1861/smartcam-common/shared-proto/iam";

import "google/protobuf/timestamp.proto";

// Service Definition
service IamService {
  // Authentication
  rpc Register(RegisterRequest) returns (AuthResponse);
  rpc Login(LoginRequest) returns (AuthResponse);
  rpc Logout(LogoutRequest) returns (Empty);
  rpc RefreshToken(RefreshTokenRequest) returns (TokenPair);
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse);

  // User Management
  rpc GetUserProfile(GetUserProfileRequest) returns (User);
  rpc UpdateUserProfile(UpdateUserProfileRequest) returns (User);
  rpc ChangePassword(ChangePasswordRequest) returns (Empty);

  // Tenant Management
  rpc CreateTenant(CreateTenantRequest) returns (Tenant);
  rpc GetTenant(GetTenantRequest) returns (Tenant);
  
  // Permission Management
  rpc GrantPermission(GrantPermissionRequest) returns (Permission);
  rpc RevokePermission(RevokePermissionRequest) returns (Empty);
  rpc CheckPermission(CheckPermissionRequest) returns (CheckPermissionResponse);
  rpc GetUserPermissions(GetUserPermissionsRequest) returns (GetUserPermissionsResponse);
  rpc GetResourcePermissions(GetResourcePermissionsRequest) returns (GetResourcePermissionsResponse);

  // User Settings Management
  rpc GetUserSettings(UserSettingsRequest) returns (UserSettingsResponse);
  rpc UpdateUserSettings(UpdateUserSettingsRequest) returns (UserSettingsResponse);
  rpc ResetUserSettings(ResetUserSettingsRequest) returns (UserSettingsResponse);
  rpc GetStorageUsage(StorageUsageRequest) returns (StorageUsageResponse);

  // Session Management
  rpc LogoutAllDevices(LogoutAllDevicesRequest) returns (Empty);
  rpc GetActiveSessions(GetActiveSessionsRequest) returns (GetActiveSessionsResponse);
  rpc RevokeSession(RevokeSessionRequest) returns (Empty);
}

// Messages
message User {
  string id = 1;
  string tenant_id = 2;
  string name = 3;
  string email = 4;
  string role = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
}

message Tenant {
  string id = 1;
  string name = 2;
  string code = 3;
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp updated_at = 5;
}

message Permission {
  string id = 1;
  string user_id = 2;
  string resource_id = 3;
  string permission_type = 4;
  string tenant_id = 5;
  string granted_by = 6;
  google.protobuf.Timestamp granted_at = 7;
}

message TokenPair {
  string access_token = 1;
  string refresh_token = 2;
}

// --- Request/Response Messages ---

message RegisterRequest {
  string name = 1;
  string email = 2;
  string password = 3;
  string tenant_name = 4; // Optional: for creating a new tenant during registration
}

message LoginRequest {
  string email = 1;
  string password = 2;
}

message AuthResponse {
  User user = 1;
  TokenPair tokens = 2;
}

message RefreshTokenRequest {
  string refresh_token = 1;
}

message LogoutRequest {
  string refresh_token = 1;
}

message ValidateTokenRequest {
  string token = 1;
}

message ValidateTokenResponse {
  bool is_valid = 1;
  string user_id = 2;
  string tenant_id = 3;
  string role = 4;
}

message GetUserProfileRequest {
  string user_id = 1;
}

message UpdateUserProfileRequest {
  string user_id = 1;
  string name = 2;
}

message ChangePasswordRequest {
  string user_id = 1;
  string old_password = 2;
  string new_password = 3;
}

message CreateTenantRequest {
  string name = 1;
  string owner_id = 2;
}

message GetTenantRequest {
  string tenant_id = 1;
}

// Permission Management Messages
message GrantPermissionRequest {
  string user_id = 1;
  string resource_id = 2;
  string permission_type = 3;
  string tenant_id = 4;
  string granted_by = 5;
}

message RevokePermissionRequest {
  string user_id = 1;
  string resource_id = 2;
  string tenant_id = 3;
}

message CheckPermissionRequest {
  string user_id = 1;
  string resource_id = 2;
  string permission_type = 3;
  string tenant_id = 4;
}

message CheckPermissionResponse {
  bool has_permission = 1;
}

message GetUserPermissionsRequest {
  string user_id = 1;
  string tenant_id = 2;
}

message GetUserPermissionsResponse {
  repeated Permission permissions = 1;
}

message GetResourcePermissionsRequest {
  string resource_id = 1;
  string tenant_id = 2;
}

message GetResourcePermissionsResponse {
  repeated Permission permissions = 1;
}

message Empty {}

// User Settings Messages
message UserSettingsRequest {
  string user_id = 1;
}

message UserSettingsResponse {
  uint32 id = 1;
  string uuid = 2;
  string created_at = 3;
  string updated_at = 4;
  uint32 user_id = 5;
  uint32 tenant_id = 6;
  string theme = 7;
  string language = 8;
  string timezone = 9;
  bool notification_email = 10;
  bool notification_push = 11;
  bool notification_sound = 12;
  bool notification_motion = 13;
  bool notification_alerts = 14;
  bool notification_system = 15;
  string camera_defaults = 16;    // JSON string
  string display_preferences = 17; // JSON string
  string cloud_storage = 18;      // JSON string
  string privacy = 19;            // JSON string
}

message UpdateUserSettingsRequest {
  string user_id = 1;
  optional string theme = 2;
  optional string language = 3;
  optional string timezone = 4;
  optional bool notification_email = 5;
  optional bool notification_push = 6;
  optional bool notification_sound = 7;
  optional bool notification_motion = 8;
  optional bool notification_alerts = 9;
  optional bool notification_system = 10;
  optional string camera_defaults = 11;    // JSON string
  optional string display_preferences = 12; // JSON string
  optional string cloud_storage = 13;      // JSON string
  optional string privacy = 14;            // JSON string
}

message ResetUserSettingsRequest {
  string user_id = 1;
}

message StorageUsageRequest {
  string user_id = 1;
}

message StorageUsageResponse {
  int64 used = 1;
  int64 total = 2;
  int32 percentage = 3;
  StorageBreakdown breakdown = 4;
}

message StorageBreakdown {
  int64 videos = 1;
  int64 images = 2;
  int64 logs = 3;
  int64 other = 4;
}

// Session Management Messages
message Session {
  string uuid = 1;
  string device_type = 2;
  string device_name = 3;
  string device_id = 4;
  string ip_address = 5;
  string user_agent = 6;
  string location = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp last_used_at = 9;
  google.protobuf.Timestamp expires_at = 10;
  int32 use_count = 11;
}

message LogoutAllDevicesRequest {
  string user_id = 1;
}

message GetActiveSessionsRequest {
  string user_id = 1;
}

message GetActiveSessionsResponse {
  repeated Session sessions = 1;
}

message RevokeSessionRequest {
  string user_id = 1;
  string session_uuid = 2;
}
